# skillet preamble information used by panhandler
# ---------------------------------------------------------------------
# unique snippet name
name: DLP-Verify-Panorama
# label used for menu selection
label: DLP-Verification-Panorama
description: Skillet to test whether Panorama is connected to Enterprise DLP and ready to build policies leveraging advanced DLP Data Patterns and Data Profiles

# type of device configuration
# common types are panorama, panos, and template
# https://github.com/PaloAltoNetworks/panhandler/blob/develop/docs/metadata_configuration.rst
type: pan_validation
# preload static or default-based templates
extends:

# grouping of like snippets for dynamic menu creation in panhandler
labels:
  collection:
    - DLP

# ---------------------------------------------------------------------
# end of preamble section

# variables section
# ---------------------------------------------------------------------
# variables used in the configuration templates
# type_hint defines the form field used by panhandler
# type_hints examples include text, ip_address, or dropdown

variables:
  - name: hostname
    description: Panorama hostname or IP address
    default: Panorama
    type_hint: text
#  - name: choices
#    description: sample dropdown list
#    default: choices
#    type_hint: dropdown
#    dd_list:
#      - key: option1
#        value: option1
#      - key: option2
#        value: option2
  - name: snippets
    type_hint: hidden
    default: ''
# ---------------------------------------------------------------------
# end of variables section

# snippets section
# ---------------------------------------------------------------------
snippets:
# test for Cloud Services Plugin 1.5.0 or greater
  - name: system_info
    cmd: cli
    cmd_str: show system info
    outputs:
      - name: cloud_services_plugin
        capture_pattern: ./plugin_versions/entry[@name="cloud_services"]/@version

  - name: cloud_services_version
    label: Cloud Services Version
    test: |
      (
      cloud_services_plugin | tag_value('1.5.0')
      )
    fail_message: |
      Current plugin version is {{ cloud_services_plugin }}, please update Cloud Services plugin to 1.5.0 or greater
    pass_message: Cloud Services Plugin {{ cloud_services_plugin }} installed
    severity: High
    documentation_link: https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-release-notes/prisma-access-about/upgrade-cloud-services-plugin

# Check for Enterprise DLP specific data pattern and data filtering profile objects
  - name: device_config_file
    cmd: parse
    variable: config
    outputs:
      - name: dlp_profile
        capture_object: /config/devices/entry[@name='localhost.localdomain']/device-group/entry[@name='Remote_Network_Device_Group']/profiles/dlp-data-profiles
# - name: password_complexity
     #   capture_object: /config/mgt-config/password-complexity

# check that Enterprise DLP pre-defined Data Patterns and Data Profiles are present and ready for use in Policy
  - name: GDPR_profile_test
    label: Check for presence of Enteprise DLP GDPR Pata Profle
    test: dlp_profile | element_value_contains('entry', 'name', 'GDPR')
  #   (
  #    dlp_profiles | element_value_contains('GDPR')
  #    and dlp_profiles | tag_present('Driver License - Bulgaria')
  #    )
    fail_message: |
      Enterprise DLP has not been enabled, please request trial from Panorama > Cloud Services Configuration (Setup Tab)
      or contact your Palo Alto Networks Systems Engineer for assistance
    pass_message: Enterprise DLP Data Pattenrs and Data Profles are ready for use in Policy
    severity: High
    documentation_link: https://www.paloaltonetworks.com/resources/datasheets/enterprise-data-loss-prevention

# ---------------------------------------------------------------------
# end of snippets section